# 代码生成器核心大纲

## 1. 数据库设计

### 1.1 database_config表

- 功能：用于存储页面中数据库的相关配置，方便后续直接连接相关配置数据库，而不用重复连接
- 表名：`database_config`
- sql语句：

```sql
CREATE TABLE `database_config` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
  `config_name` varchar(16) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '配置名称',
  `database_type` enum('MYSQL','POSTGRESQL') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '数据库类型，MYSQL或POSTGRESQL',
  `host` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '主机地址',
  `port` int NOT NULL COMMENT '端口号',
  `database_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '数据库名称',
  `creator` varchar(64) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '创建者标识（V1版本不涉及，可按需删除）',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间（V1版本不涉及，可按需删除）',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间（V1版本不涉及，可按需删除）',
  `is_delete` tinyint(1) DEFAULT '0' COMMENT '删除标志，0表示未删除，1表示删除，（V1版本不涉及，可按需删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `config_name_unique` (`config_name`) COMMENT '唯一配置名'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用于存储页面中数据库的相关配置，方便后续直接连接相关配置数据库，而不用重复连接';
```

- 字段说明：

|字段名|字段类型|说明|
|:--:|:--:|:--:|
|id|bigint|自增主键id|
|config_name|varchar|配置名称，前端由用户保存配置时输入，长度不能超过16，且全局必须唯一|
|database_type|enum|枚举对象，与Java中数据库类型一一对应，目前包括Mysql和PostgreSQL|
|host|varchar|主机地址|
|port|int|端口号|
|database_name|varchar|数据库名称|

## 2. API设计

### 2.1 基础配置

- 前端请求基础url：`/api/code_generator`
- 后端放出基础url：`/code_generator`
- 身份认证：无（后续V2版本计划添加登录功能，有了登录功能后会引入相关鉴权方式）
- 响应基本格式：

```json
{
  "code": 200,
  "message": "成功",
  "data": ...,
  "timestamp": 1756474982301
}
```

- 响应格式说明：

|响应字段|字段类型|说明|
|:--:|:--:|:--:|
|code|int|状态码，与HTTP请求返回状态码对应|
|message|String|提示信息，用于请求成功或失败时进行提示的信息|
|data|Object|后端返回前端真正的数据|
|timestamp|long|请求返回时的时间|

### 2.2 核心API接口示例

- 这部分仅显示`方法、路由、描述`，如果要查看`参数、返回值、设计说明、异常说明`，请参考**2.3 核心API详细说明**

|方法|          路由           |描述|
|:--:|:---------------------:|:--:|
|GET|    /database/types    |数据库类型|
|POST| /database/connections |测试连接数据库|
|POST|  /database/patterns   |数据库中的模式|
|POST|   /database/tables    |数据库中的表|
|POST|    /database/save     |保存配置|
|POST|    /code/filenames    |生成代码的文件名|
|POST|     /code/content     |文件对应代码|
|POST|    /code/download     |下载代码|

### 2.3 核心API详细说明

- ==注意：此处的返回值仅包括data部分，此处异常仅包括一些自定义异常==

1. 数据库类型
    1. 参数：无
    2. 返回值：
       ```json
          [
            {
              "name": "MySQL",
              "value": "MYSQL"
            },
            {
              "name": "PostgreSQL",
              "value": "POSTGRESQL"
            }
          ]
       ```
    3. 设计说明：无
    4. 异常说明：无
2. 测试连接数据库
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "changeFlag": false     // 表征是否对配置信息进行更改
       }
       ```
    2. 返回值：
       ```json
       {
         "state": true,
         "databaseId": 1,    // 数据库实例databaseId，用于从数据库对应数据库中获取数据
       }
       ```
    3. 设计说明：
        1. 根据基本信息进行连接测试， 连接成功后，生成一个databaseId，将该databaseId以及对应的Java连接对象进行缓存，后续同一连接可以直接调用，同时会保存id对应的基本连接信息，后续进行请求时，均需要先判断id对应请求信息是否正确
        2. 当数据库连接信息改变时（会在前端进行验证，只有当内容改变时，才会将changeFlag状态改为true，当改为true时，会重新生成一个连接实体，由于每个人连接数据库基本有限，因此可以考虑直接在内存中进行缓存
    4. 异常说明：
        1. `DatabaseTypeNotFoundException`：数据库类型不存在异常
3. 数据库中的模式
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "pattern": "public",
         "databaseId": 1
       }
       ```
    2. 返回值：
       ```json
       ["public", "private", ...]
       ```
    3. 设计说明：
        1. 请求时需包含数据库连接databaseId，如不携带，前端会自动先进行一次连接测试，拿到databaseId后进行新的请求
        2. 请求时，pattern可以为空，届时需设计防抖函数，根据输入从数据库中模糊查询对应模式
        3. 返回值是模糊查询的所有模式列表，前端可通过列表方式进行呈现
    4. 异常说明：
        1. `ConnectionInformationErrorException`：连接信息错误异常
4. 数据库中的表
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "tableName": "test",
         "databaseId": 1
       }
       ```
    2. 返回值：
       ```json
       ["test", "main", "user", ...]
       ```
    3. 设计说明：
        1. 请求时需包含数据库连接databaseId，如不携带，前端会自动先进行一次连接测试，拿到databaseId后进行新的请求
        2. 请求时，tableName可以为空，届时需设计防抖函数，根据输入从数据库中模糊查询对应模式
        3. 返回值是模糊查询的所有表列表，前端可通过列表方式进行呈现
    4. 异常说明：
        1. `ConnectionInformationErrorException`：连接信息错误异常
5. 保存配置
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "databseId": 1,
         "configName": "测试"
       }
       ```
    2. 返回值：
       ```json
       {
         "state": true
       }
       ```
    3. 设计说明：
        1. 请求时需包含数据库连接databaseId，如不携带，前端会自动先进行一次连接测试，拿到databaseId后进行新的请求
        2. 先验证连接信息是否正确，再进行保存
    4. 异常说明：
        1. `ConnectionInformationErrorException`：连接信息错误异常
        2. `ConfigurationNameDuplicateException`：配置名已存在异常
6. 生成代码的文件名
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "databseId": 1,
         "createEntity": true,   // 生成实体
         "createRepository": true,  // 生成存储库（mybatis的xml文件以及**Mapper.java）
         "createController": false,   // 生成controller层
         "createService": false,     // 生成service层
         "createSimpleSql": false,   // 生成简单增删改查语句
         "prePackageName": 'cn.com.web.wzy'    // 前置包名，用于生成entity、controller等包的前置包
       }
       ```
    2. 返回值：
       ```json
       ["UserEntity.java", "UserMapper.java", "UserMapper.xml", ...]
       ```
    3. 设计说明：
        1. 根据配置信息生成对应的文件名，这一步不生成对应代码，仅生成文件名，但这一步会对文件名列表进行缓存，用于获取代码时文件名存在与否验证
    4. 异常说明：
        1. `ConnectionInformationErrorException`：连接信息错误异常
7. 文件对应代码
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "databaseId": 1,
         "fileName": "UserEntity.java"
       }
       ```
    2. 返回值：
       ```json
       {
         "code": "package cn.com.web.wzy.entity;\n......"
       }
       ```
    3. 设计说明：
        1. 根据文件名生成对应的代码，并将代码进行返回
    4. 异常说明：
        1. `ConnectionInformationErrorException`：连接信息错误异常
        2. `FileNotFoundException`：文件不存在异常
8. 下载代码
    1. 参数：
       ```json
       {
         "databaseType": "MYSQL",
         "host": "localhost",
         "port": 3306,
         "databaseName": "test",
         "databseId": 1,
         "createEntity": true,   // 生成实体
         "createRepository": true,  // 生成存储库（mybatis的xml文件以及**Mapper.java）
         "createController": false,   // 生成controller层
         "createService": false,     // 生成service层
         "createSimpleSql": false,   // 生成简单增删改查语句
         "prePackageName": 'cn.com.web.wzy'    // 前置包名，用于生成entity、controller等包的前置包
       }
       ```
    2. 返回值：
       ```json
       {
         "url": "http://localhost:8080/temp/user_code.zip",
         "message": "请尽快保存该文件，文件将于5分钟后自动删除。"
       }
       ```
    3. 设计说明：
        1. 根据相关配置信息生成对应的文件，并保存到temp文件夹中
        2. 开辟新的线程，设置5分钟后删除对应文件
        3. ==当启动项目时，先删除temp文件夹及其内所有文件（清除缓存，预防因文件生成中途，服务器异常导致的残缺文件残留）==
    4. 异常说明：
        1. `ConnectionInformationErrorException`：连接信息错误异常
        2. `FileGenerationErrorException`：文件生成错误异常

### 2.4 前端参数

- 前端对于各类参数全部存储在一个form对象中，该对象结构如下：

```typescript
const form : RequestType = ref({
  databaseId: -1,
  databaseType: 'MYSQL',
  host: 'localhost',
  port: 3306,
  databaseName: '',
  changeFlag: true,
  pattern: '',
  table: '',
  configName: '',
  createEntity: true,
  createRepository: true,
  createController: false,
  createService: false,
  createSimpleSql: false, 
  prePackageName: '' 
})
```

- 前端form变量对应的接口RequestType

```typescript
interface RequestType {
  databaseId: number,
  databaseType: string,
  host: string,
  port: number,
  databaseName: string,
  changeFlag: boolean,
  pattern: string,
  table: string,
  configName: string,
  createEntity: boolean,
  createRepository: boolean,
  createController: boolean,
  createService: boolean,
  createSimpleSql: boolean, 
  prePackageName: string 
}
```

### 2.5 后端参数

1. `ResponseBodyEntity.java`：后台响应主体类型

```java
public class ResponseBodyEntity{
  private Integer code;
  private String message;
  private Object data;
  private Long timestamp;
  
  ......
}
```

2. `RequestVo.java`：前端请求实体

```java
public class RequestVo {
    private int databaseId;
    private String databaseType;
    private String host;
    private int port;
    private String databaseName;
    private boolean changeFlag;
    private String pattern;
    private String table;
    private String configName;
    private boolean createEntity;
    private boolean createRepository;
    private boolean createController;
    private boolean createService;
    private boolean createSimpleSql;
    private String prePackageName;
    
    ......
}
```

### 2.6 异常总结

|异常名称|说明|
|:--:|:--:|
|DatabaseTypeNotFoundException|数据库类型不存在异常|
|ConnectionInformationErrorException|连接信息错误异常|
|ConfigurationNameDuplicateException|配置名已存在异常|
|FileNotFoundException|文件不存在异常|
|FileGenerationErrorException|文件生成错误异常|

## 3. 数据库类型与Java实体类型之间映射

### 3.1 Mysql

|MySQL数据类型|Java数据类型|说明|
|--|--|--|
|TINYINT|byte|1字节整数，范围-128~127|
|TINYINT(1)|boolean/Boolean|通常用于表示布尔值（0=false，1=true）|
|SMALLINT|short|2字节整数，范围-32768~32767|
|MEDIUMINT|int|3字节整数，范围-8388608~8388607|
|INT/INTEGER|int|4字节整数，范围-2147483648~2147483647|
|BIGINT|long|8字节整数，范围-9223372036854775808~9223372036854775807|
|FLOAT|float|单精度浮点数|
|DOUBLE|double|双精度浮点数|
|DECIMAL(p,s)|java.math.BigDecimal|高精度十进制数，适合财务计算|
|CHAR(n)|String|固定长度字符串|
|VARCHAR(n)|String|可变长度字符串|
|TINYTEXT|String|短文本，最大长度255字节|
|TEXT|String|文本，最大长度65535字节|
|MEDIUMTEXT|String|中等文本，最大长度16777215字节|
|LONGTEXT|String|长文本，最大长度4294967295字节|
|DATE|java.sql.Date / java.time.LocalDate|日期（年-月-日）|
|TIME|java.sql.Time / java.time.LocalTime|时间（时:分:秒）|
|DATETIME|java.sql.Timestamp / java.time.LocalDateTime|日期时间（年-月-日 时:分:秒）|
|TIMESTAMP|java.sql.Timestamp / java.time.LocalDateTime|带时区的日期时间|
|YEAR|int|年份（1901~2155）|
|TINYBLOB|byte[]|二进制数据，最大255字节|
|BLOB|byte[]|二进制数据，最大65535字节|
|MEDIUMBLOB|byte[]|二进制数据，最大16777215字节|
|LONGBLOB|byte[]|二进制数据，最大4294967295字节|
|ENUM|String|枚举类型，存储预定义值之一|
|SET|String|集合类型，存储预定义值的组合|
|BIT|byte[] / boolean（BIT(1)）|位字段，BIT(1)可映射为布尔值|

- ==不在映射表中的类型全部转为String类型==

### 3.2 PostgreSQL

|PostgreSQL数据类型|Java数据类型|说明|
|--|--|--|
|smallint|short / Short|2字节整数，范围-32768~32767|
|integer / int4|int / Integer|4字节整数，范围-2147483648~2147483647|
|bigint / int8|long / Long|8字节整数，范围-9223372036854775808~9223372036854775807|
|real|float / Float|4字节单精度浮点数，精度约6位小数|
|double precision|double / Double|8字节双精度浮点数，精度约15位小数|
|numeric(p,s) / decimal(p,s)|java.math.BigDecimal|高精度十进制数，适合财务、货币等需要精确计算的场景|
|boolean|boolean / Boolean|布尔值，取值为true/false|
|char(n)|String|固定长度字符串，不足补空格|
|varchar(n)|String|可变长度字符串，最大长度为n|
|text|String|可变长度字符串，无最大长度限制（实际受系统内存限制）|
|date|java.time.LocalDate|日期（年-月-日），无时间信息|
|time [without time zone]|java.time.LocalTime|时间（时:分:秒.毫秒），无日期和时区信息|
|time with time zone|java.time.OffsetTime|带时区的时间信息|
|timestamp [without time zone]|java.time.LocalDateTime|日期时间（年-月-日 时:分:秒.毫秒），无时区信息|
|timestamp with time zone|java.time.ZonedDateTime|带时区的日期时间信息（PostgreSQL内部存储为UTC时间）|
|interval|java.time.Duration / java.time.Period|时间间隔（如"1 day 2 hours"），根据间隔类型选择Duration（时间）或Period（日期）|
|bytea|byte[]|二进制数据，用于存储图片、文件等二进制内容|
|uuid|java.util.UUID|通用唯一标识符，36位字符串格式|
|json|String / com.fasterxml.jackson.databind.JsonNode|JSON文本，可映射为字符串或JSON对象|
|jsonb|String / com.fasterxml.jackson.databind.JsonNode|二进制JSON（优化存储和查询），映射方式同json|
|array (如integer[], varchar[])|对应基本类型数组（int[]、String[]）|PostgreSQL支持数组类型，直接映射为Java对应类型的数组|
|enum|String / 自定义枚举类|枚举类型，可映射为字符串（存储枚举值）或自定义Java枚举类|
|money|java.math.BigDecimal|货币类型，精确到分，建议用BigDecimal处理|
|inet|String / java.net.InetAddress|IP地址（IPv4/IPv6），可映射为字符串或InetAddress对象|
|cidr|String|无类别域间路由（CIDR）地址，如"192.168.1.0/24"|
|point|自定义对象（如包含x、y坐标的类）|几何点类型（x,y），需自定义Java类映射|
|line|自定义对象|几何线类型，需自定义Java类映射|
|ltree|String|层次树结构，通常映射为字符串|

- ==不在映射表中的类型全部转为String类型==

## 4. 安全设计

- 密码加密：BCrypt算法

- SQL注入防护：使用预编译语句

- API限流：关键接口添加访问频率限制